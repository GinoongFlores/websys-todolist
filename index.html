<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Todo List App</title>
    <link rel="stylesheet" href="style/style.css" />
  </head>
  <body>
    <div class="todo-container">
      <div class="todo-header">
        <h1>Todo List</h1>
        <div>
          <span id="userEmail"></span>
          <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
      </div>

      <form id="todoForm" class="todo-form">
        <input
          type="text"
          id="todoInput"
          placeholder="Add a new task..."
          required
        />
        <button type="submit">Add Task</button>
      </form>

      <div id="todoList" class="todo-list">
        <!-- Todo items will be inserted here dynamically -->
      </div>
      <div
        id="loadingState"
        style="text-align: center; padding: 1rem; display: none"
      >
        Loading tasks...
      </div>
      <div
        id="errorState"
        style="text-align: center; padding: 1rem; color: #f44336; display: none"
      ></div>
    </div>

    <script type="module">
      import { auth, db } from "./js/firebase-config.js";
      import { signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        collection,
        addDoc,
        query,
        where,
        onSnapshot,
        doc,
        updateDoc,
        deleteDoc,
        orderBy,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // Auth state check
      auth.onAuthStateChanged((user) => {
        if (!user) {
          window.location.href = "login.html";
        } else {
          document.getElementById("userEmail").textContent = user.email;
          setupTodoListeners(user.uid);
        }
      });

      // Logout functionality
      document
        .getElementById("logoutBtn")
        .addEventListener("click", async () => {
          try {
            await signOut(auth);
            window.location.href = "login.html";
          } catch (error) {
            console.error("Error signing out:", error);
          }
        });

      // Setup todo listeners
      function setupTodoListeners(userId) {
        const todoList = document.getElementById("todoList");
        const loadingState = document.getElementById("loadingState");
        const errorState = document.getElementById("errorState");

        loadingState.style.display = "block";
        errorState.style.display = "none";

        const q = query(
          collection(db, "todos"),
          where("userId", "==", userId), // First: Find todos for specific user
          orderBy("timestamp", "desc") // Second: Order these todos by timestamp
        );

        // Real-time updates
        const unsubscribe = onSnapshot(
          q,
          (snapshot) => {
            loadingState.style.display = "none";
            errorState.style.display = "none";
            todoList.innerHTML = "";

            if (snapshot.empty) {
              todoList.innerHTML =
                '<div style="text-align: center; padding: 1rem;">No tasks yet. Add your first task above!</div>';
              return;
            }

            snapshot.forEach((doc) => {
              const todo = doc.data();
              const div = document.createElement("div");
              div.className = `todo-item ${todo.completed ? "completed" : ""}`;
              div.innerHTML = `
                        <input type="checkbox" class="checkbox" ${
                          todo.completed ? "checked" : ""
                        }>
                        <span class="text">${todo.text}</span>
                        <div class="actions">
                            <button class="delete-btn">Delete</button>
                        </div>
                    `;

              // Toggle completion
              div
                .querySelector(".checkbox")
                .addEventListener("change", async (e) => {
                  try {
                    await updateDoc(doc.ref, {
                      completed: e.target.checked,
                    });
                  } catch (error) {
                    console.error("Error updating todo:", error);
                    errorState.textContent =
                      "Failed to update task. Please try again.";
                    errorState.style.display = "block";
                    e.target.checked = !e.target.checked; // Revert the checkbox
                  }
                });

              // Delete todo
              div
                .querySelector(".delete-btn")
                .addEventListener("click", async () => {
                  try {
                    await deleteDoc(doc.ref);
                  } catch (error) {
                    console.error("Error deleting todo:", error);
                    errorState.textContent =
                      "Failed to delete task. Please try again.";
                    errorState.style.display = "block";
                  }
                });

              todoList.appendChild(div);
            });
          },
          (error) => {
            console.error("Error fetching todos:", error);
            loadingState.style.display = "none";

            // Check specifically for missing index error
            if (
              error.code === "failed-precondition" &&
              error.message.includes("index")
            ) {
              errorState.innerHTML =
                "Setting up the database... This might take a few minutes. " +
                'Please wait or <a href="javascript:location.reload()">refresh the page</a> to try again.';
            } else {
              errorState.textContent =
                "Failed to load tasks. Please refresh the page.";
            }
            errorState.style.display = "block";
          }
        );

        // Add new todo
        document
          .getElementById("todoForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const input = document.getElementById("todoInput");
            const text = input.value.trim();
            errorState.style.display = "none";

            if (text) {
              try {
                await addDoc(collection(db, "todos"), {
                  text,
                  completed: false,
                  userId,
                  timestamp: new Date(),
                });
                input.value = "";
              } catch (error) {
                console.error("Error adding todo:", error);
                errorState.textContent =
                  "Failed to add task. Please try again.";
                errorState.style.display = "block";
              }
            }
          });

        // Cleanup listener on page unload
        window.addEventListener("unload", () => unsubscribe());
      }
    </script>
  </body>
</html>
